#!/bin/bash -ex

export DESTDIR="/var/www/miq/vmdb"

mkdir -p $DESTDIR
cp -Rf /tmp/src/. $DESTDIR
cd $DESTDIR

source /opt/rh/rh-ruby22/enable
export BUNDLE_WITHOUT=test:metric_fu:development
bundle config build.nokogiri --use-system-libraries

ADDTL_BUNDLE_ARGS=""
if [ -f Gemfile.lock ]; then
  ADDTL_BUNDLE_ARGS="--deployment"
fi
bundle install --retry=3 --jobs=3 --path ./bundle $ADDTL_BUNDLE_ARGS
bundle clean -V

cp $DESTDIR/certs/v2_key.dev $DESTDIR/certs/v2_key
cp /database.openshift.yml $DESTDIR/config/database.yml
echo '0' > REGION
echo "$(date +"%Y%m%d%H%M%S")_${OPENSHIFT_BUILD_COMMIT:0:8}" > BUILD
