#!/bin/bash -ex

export HTTP_PROXY=http://proxy.default.svc.cluster.local:3128
export HTTPS_PROXY=http://proxy.default.svc.cluster.local:3128

export DESTDIR="/var/www/miq/vmdb"

mkdir -p $DESTDIR
cp -Rf /tmp/src/. $DESTDIR
cd $DESTDIR

source /opt/rh/rh-ruby22/enable
echo "Installing bundler"
echo "gem: --no-ri --no-rdoc --no-document" > ~/.gemrc
gem install bundler
export BUNDLE_WITHOUT=test:metric_fu:development
bundle config build.nokogiri --use-system-libraries

echo "Installing gems"
if [ -f Gemfile.lock ]; then
	bundle install --deployment
else
	bundle install --retry=3 --jobs=3
fi

cp $DESTDIR/certs/v2_key.dev $DESTDIR/certs/v2_key

echo "Running misc tasks"
echo '0' > REGION
bundle exec rake evm:compile_assets
bundle exec rake evm:compile_sti_loader

echo "EVM has been set up"
